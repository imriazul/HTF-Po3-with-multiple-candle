//@version=5
indicator("HTF po3 by @imriazul", overlay=true")

//==================== INPUTS ====================
grp_time = "Time Settings"
tzInput  = input.string("America/New_York", "Timezone", options=["America/New_York","Europe/London","Asia/Tokyo"], group=grp_time)
htfTf    = input.timeframe("D", "HTF Timeframe (60, 180, 240, D, W)", group=grp_time)

grp_vis  = "Visuals"
showWick = input.bool(true, "Show Wick", group=grp_vis)
showBody = input.bool(true, "Show Body", group=grp_vis)

upColor   = input.color(color.rgb(11, 142, 15), "Bull Body", group=grp_vis)
dnColor   = input.color(color.new(#ff5252, 0), "Bear Body", group=grp_vis)
wickColor = input.color(color.gray, "Wick Color", group=grp_vis)

bodyWidth = input.int(2, "Body Width (bars)", minval=2, maxval=200, group=grp_vis)
wickWidth = input.int(1, "Wick Width", minval=1, maxval=4, group=grp_vis)

grp_pos     = "Position"
rightOffset = input.int(20, "Right Offset (bars)", minval=1, maxval=300, group=grp_pos)
gapBars     = input.int(1, "Gap Between Candles (bars)", minval=0, maxval=50, group=grp_pos)

//==================== HTF BAR CHANGE (TZ SAFE) ====================
bool isNewHTF = ta.change(time(htfTf, tzInput))

//==================== TRACK CURRENT HTF ====================
var float curO = na
var float curH = na
var float curL = na

//==================== PREV 3 COMPLETED HTF ====================
var float pO1 = na
var float pH1 = na
var float pL1 = na
var float pC1 = na

var float pO2 = na
var float pH2 = na
var float pL2 = na
var float pC2 = na

var float pO3 = na
var float pH3 = na
var float pL3 = na
var float pC3 = na

//==================== SHIFT ON NEW HTF ====================
if isNewHTF and not na(curO) and bar_index > 0
    pO3 := pO2
    pH3 := pH2
    pL3 := pL2
    pC3 := pC2

    pO2 := pO1
    pH2 := pH1
    pL2 := pL1
    pC2 := pC1

    pO1 := curO
    pH1 := curH
    pL1 := curL
    pC1 := close[1]

//==================== UPDATE CURRENT HTF ====================
if isNewHTF or na(curO)
    curO := open
    curH := high
    curL := low
else
    curH := math.max(curH, high)
    curL := math.min(curL, low)

float curC = close

//==================== DRAW FUNCTION ====================
f_drawCandle(_o, _h, _l, _c, _x) =>
    line w = na
    box  b = na

    if not na(_o) and not na(_h) and not na(_l) and not na(_c)
        float top = math.max(_o, _c)
        float bot = math.min(_o, _c)
        if top == bot
            top += syminfo.mintick

        color bodyCol = _c >= _o ? upColor : dnColor

        int leftX  = _x - int(math.floor(bodyWidth / 2))
        int rightX = _x + int(math.ceil(bodyWidth / 2))

        if showWick
            w := line.new(_x, _h, _x, _l, color=wickColor, width=wickWidth)

        if showBody
            b := box.new(leftX, top, rightX, bot, bgcolor=bodyCol, border_color=color.new(bodyCol, 0))

    [w, b]

//==================== FIXED RIGHT POS ====================
int anchorX = bar_index + rightOffset
int stepX   = bodyWidth + gapBars

var line w0 = na
var line w1 = na
var line w2 = na
var line w3 = na

var box b0 = na
var box b1 = na
var box b2 = na
var box b3 = na

// delete old objects safely
if not na(w0)
    line.delete(w0)
if not na(b0)
    box.delete(b0)

if not na(w1)
    line.delete(w1)
if not na(b1)
    box.delete(b1)

if not na(w2)
    line.delete(w2)
if not na(b2)
    box.delete(b2)

if not na(w3)
    line.delete(w3)
if not na(b3)
    box.delete(b3)

// temp vars (destructure only with '=')
[tw0, tb0] = f_drawCandle(pO3, pH3, pL3, pC3, anchorX)
[tw1, tb1] = f_drawCandle(pO2, pH2, pL2, pC2, anchorX + stepX)
[tw2, tb2] = f_drawCandle(pO1, pH1, pL1, pC1, anchorX + stepX * 2)
[tw3, tb3] = f_drawCandle(curO, curH, curL, curC, anchorX + stepX * 3)

// assign to persistent handles
w0 := tw0
b0 := tb0
w1 := tw1
b1 := tb1
w2 := tw2
b2 := tb2
w3 := tw3
b3 := tb3